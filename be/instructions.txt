# ğŸ“š HÆ°á»›ng Dáº«n Chi Tiáº¿t - Há»‡ Thá»‘ng Admin & CRUD

## ğŸ¯ Tá»”NG QUAN NHá»®NG GÃŒ ÄÃƒ THÃŠM/Sá»¬A

### âœ… 1. Authentication & Authorization System
**Files má»›i táº¡o:**
- `be/app/middleware/auth_middleware.py` - JWT middleware vá»›i role-based access control

**Chá»©c nÄƒng:**
- Táº¡o JWT token khi login
- Verify token cho cÃ¡c protected routes
- Check role (Admin/Child) cho tá»«ng endpoint
- Decode token Ä‘á»ƒ láº¥y user_id, username, role

**CÃ¡ch hoáº¡t Ä‘á»™ng:**
```python
# Táº¡o token khi login
access_token = create_access_token(
    data={"user_id": "...", "username": "...", "role": "admin"}
)

# Protect endpoint chá»‰ cho admin
@router.get("/users", dependencies=[Depends(verify_admin)])

# Protect endpoint cho cáº£ admin vÃ  child
@router.get("/games", dependencies=[Depends(verify_token)])
```

---

### âœ… 2. Admin Management System
**Files má»›i táº¡o:**
- `be/app/controllers/admin/admin_controller.py` - Admin endpoints
- `be/app/services/admin/admin_service.py` - Admin business logic

**Endpoints admin cÃ³:**

#### **GET /api/admin/users** ğŸ”’ (Admin only)
Láº¥y danh sÃ¡ch táº¥t cáº£ users vá»›i pagination vÃ  filter
```bash
GET /api/admin/users?skip=0&limit=10&role=child
Authorization: Bearer <admin_token>
```
Response:
```json
{
  "status": "success",
  "data": [
    {
      "user_id": "...",
      "username": "user1",
      "email": "user1@example.com",
      "name": "User One",
      "role": "child"
    }
  ],
  "total": 50,
  "skip": 0,
  "limit": 10
}
```

#### **GET /api/admin/users/{user_id}** ğŸ”’ (Admin only)
Láº¥y chi tiáº¿t user (kÃ¨m child info náº¿u lÃ  child)
```bash
GET /api/admin/users/123e4567-e89b-12d3-a456-426614174000
Authorization: Bearer <admin_token>
```

#### **PUT /api/admin/users/{user_id}** ğŸ”’ (Admin only)
Cáº­p nháº­t thÃ´ng tin user
```bash
PUT /api/admin/users/123e4567-e89b-12d3-a456-426614174000
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "name": "New Name",
  "email": "newemail@example.com",
  "age": 10,
  "gender": "male"
}
```

#### **DELETE /api/admin/users/{user_id}** ğŸ”’ (Admin only)
XÃ³a user (cascade delete child record náº¿u cÃ³)

#### **GET /api/admin/children** ğŸ”’ (Admin only)
Láº¥y danh sÃ¡ch táº¥t cáº£ children (join vá»›i user data)

#### **GET /api/admin/statistics** ğŸ”’ (Admin only)
Láº¥y thá»‘ng kÃª há»‡ thá»‘ng
```json
{
  "status": "success",
  "data": {
    "total_users": 100,
    "total_children": 80,
    "total_admins": 20,
    "total_child_records": 80
  }
}
```

---

### âœ… 3. Emotion Concepts System (Learn Section)
**Files má»›i táº¡o:**
- `be/app/controllers/sessions/emotion_concepts_controller.py`
- `be/app/services/sessions/emotion_concepts_service.py` (updated)
- `be/app/repository/emotion_concepts_repo.py` (updated)
- `be/app/mapper/emotion_concepts_mapper.py`

**Endpoints:**

#### **GET /api/emotion-concepts** ğŸ”“ (Authenticated users)
Láº¥y danh sÃ¡ch emotion concepts vá»›i filter
```bash
GET /api/emotion-concepts?emotion=vui&level=1
Authorization: Bearer <token>
```

#### **GET /api/emotion-concepts/{emotion}/{level}** ğŸ”“
Láº¥y concept theo emotion vÃ  level cá»¥ thá»ƒ
```bash
GET /api/emotion-concepts/vui/1
Authorization: Bearer <token>
```
Response:
```json
{
  "status": "success",
  "data": {
    "concept_id": "...",
    "emotion": "vui",
    "level": 1,
    "title": "KhÃ¡i niá»‡m cáº£m xÃºc vui",
    "video_path": "/videos/vui_level1.mp4",
    "image_path": "/images/vui_level1.png",
    "audio_path": "/audio/vui_level1.mp3",
    "description": "MÃ´ táº£ vá» cáº£m xÃºc vui..."
  }
}
```

#### **POST /api/emotion-concepts** ğŸ”’ (Admin only)
Táº¡o emotion concept má»›i
```bash
POST /api/emotion-concepts
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "emotion": "vui",
  "level": 1,
  "title": "KhÃ¡i niá»‡m vui",
  "video_path": "/videos/vui.mp4",
  "image_path": "/images/vui.png",
  "audio_path": "/audio/vui.mp3",
  "description": "MÃ´ táº£..."
}
```

#### **PUT /api/emotion-concepts/{concept_id}** ğŸ”’ (Admin only)
Cáº­p nháº­t emotion concept

#### **DELETE /api/emotion-concepts/{concept_id}** ğŸ”’ (Admin only)
XÃ³a emotion concept

---

### âœ… 4. Questions Management System
**Files má»›i táº¡o:**
- `be/app/controllers/games/questions_controller.py`
- `be/app/services/games/question_service.py` (updated)

**Endpoints:**

#### **GET /api/games/{game_id}/questions** ğŸ”“
Láº¥y danh sÃ¡ch questions theo game
```bash
GET /api/games/abc123.../questions?level=1
Authorization: Bearer <token>
```

#### **GET /api/questions/{question_id}** ğŸ”“
Láº¥y chi tiáº¿t question

#### **POST /api/questions** ğŸ”’ (Admin only)
Táº¡o question má»›i
```bash
POST /api/questions
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "game_id": "abc123...",
  "level": 1,
  "content": {
    "game_id": "abc123...",
    "level": 1,
    "content_type": "image",
    "media_path": "/images/q1.png",
    "question_text": "Cáº£m xÃºc nÃ y lÃ  gÃ¬?",
    "correct_answer": "vui",
    "emotion": "vui",
    "explanation": "..."
  },
  "answer_options": [
    { "...": "4 options tÆ°Æ¡ng tá»± content" }
  ],
  "correct_answer": "vui"
}
```

#### **PUT /api/questions/{question_id}** ğŸ”’ (Admin only)
Cáº­p nháº­t question

#### **DELETE /api/questions/{question_id}** ğŸ”’ (Admin only)
XÃ³a question

#### **GET /api/games/{game_id}/questions/random** ğŸ”“
Láº¥y random questions cho game session
```bash
GET /api/games/abc123.../questions/random?level=1&count=10
Authorization: Bearer <token>
```

---

### âœ… 5. Game Contents Management System
**Files má»›i táº¡o:**
- `be/app/controllers/games/game_contents_controller.py`
- `be/app/services/games/game_contents_service.py`

**Endpoints:**

#### **GET /api/games/{game_id}/contents** ğŸ”“
Láº¥y danh sÃ¡ch contents theo game
```bash
GET /api/games/abc123.../contents?level=1&emotion=vui
Authorization: Bearer <token>
```

#### **GET /api/contents/{content_id}** ğŸ”“
Láº¥y chi tiáº¿t content

#### **POST /api/contents** ğŸ”’ (Admin only)
Táº¡o content má»›i
```bash
POST /api/contents
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "game_id": "abc123...",
  "level": 1,
  "content_type": "image",
  "media_path": "/images/content1.png",
  "question_text": "ÄÃ¢y lÃ  cáº£m xÃºc gÃ¬?",
  "correct_answer": "vui",
  "emotion": "vui",
  "explanation": "Giáº£i thÃ­ch..."
}
```

#### **PUT /api/contents/{content_id}** ğŸ”’ (Admin only)
Cáº­p nháº­t content

#### **DELETE /api/contents/{content_id}** ğŸ”’ (Admin only)
XÃ³a content

#### **GET /api/contents/emotion/{emotion}** ğŸ”“
Láº¥y contents theo emotion

---

### âœ… 6. Users Controller Updates
**File Ä‘Ã£ sá»­a:**
- `be/app/controllers/users/users_controller.py`
- `be/app/services/users/users_service.py`

**Cáº­p nháº­t:**
- Login endpoint giá» tráº£ vá» JWT token
- Response thÃªm `access_token` vÃ  `token_type`
- Service login method thÃªm `user_id` vÃ o response

**Login endpoint má»›i:**
```bash
POST /api/users/login
Content-Type: application/json

{
  "username": "user1",
  "password": "password123"
}
```
Response:
```json
{
  "success": true,
  "message": "ÄÄƒng nháº­p thÃ nh cÃ´ng",
  "user": {
    "user_id": "123e4567...",
    "username": "user1",
    "fullName": "User One",
    "accountType": "child"
  },
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

---

### âœ… 7. Repository & Mapper Updates
**Files má»›i táº¡o/sá»­a:**
- `be/app/repository/child_repo.py` - ThÃªm methods: `save`, `update`, `get_by_user_id`, `delete`, `get_all`
- `be/app/mapper/child_mapper.py` - Mapper cho Child entity
- `be/app/mapper/emotion_concepts_mapper.py` - Mapper cho EmotionConcept
- `be/app/repository/emotion_concepts_repo.py` - ThÃªm methods: `get_by_emotion_and_level`, `get_all`

---

## ğŸ”§ CÃCH Sá»¬ Dá»¤NG

### 1. CÃ i Ä‘áº·t dependencies
```bash
cd be
pip install -r requirements.txt
```

### 2. Cáº¥u hÃ¬nh .env
```bash
cp .env.example .env
# Sá»­a cÃ¡c giÃ¡ trá»‹ trong .env
```

### 3. Cháº¡y server
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 4. Test endpoints

#### **Step 1: Login Ä‘á»ƒ láº¥y token**
```bash
curl -X POST http://localhost:8000/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```
Copy `access_token` tá»« response

#### **Step 2: Gá»i protected endpoints**
```bash
# Láº¥y danh sÃ¡ch users (admin only)
curl -X GET http://localhost:8000/api/admin/users \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"

# Láº¥y emotion concepts
curl -X GET http://localhost:8000/api/emotion-concepts \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"

# Táº¡o question má»›i (admin only)
curl -X POST http://localhost:8000/api/questions \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d '{"game_id":"...","level":1,...}'
```

---

## ğŸ” PHÃ‚N QUYá»€N

### Admin cÃ³ thá»ƒ:
- âœ… Quáº£n lÃ½ users (CRUD)
- âœ… Quáº£n lÃ½ emotion concepts (CRUD)
- âœ… Quáº£n lÃ½ questions (CRUD)
- âœ… Quáº£n lÃ½ game contents (CRUD)
- âœ… Xem thá»‘ng kÃª há»‡ thá»‘ng
- âœ… Truy cáº­p táº¥t cáº£ endpoints

### Child cÃ³ thá»ƒ:
- âœ… Xem emotion concepts (Read only)
- âœ… Xem questions (Read only)
- âœ… Xem game contents (Read only)
- âœ… ChÆ¡i games
- âŒ KHÃ”NG thá»ƒ CRUD dá»¯ liá»‡u

---

## ğŸ“Š DATABASE CHANGES NEEDED

Äáº£m báº£o cÃ¡c báº£ng sau tá»“n táº¡i:
- `users` (cÃ³ sáºµn)
- `children` (cÃ³ sáºµn)
- `emotion_concepts` (cÃ³ sáºµn)
- `game_content` (cÃ³ sáºµn)
- `questions` (cÃ³ sáºµn)
- `question_answer_options` (cÃ³ sáºµn)

KhÃ´ng cáº§n migration má»›i vÃ¬ táº¥t cáº£ tables Ä‘Ã£ cÃ³ trong code hiá»‡n táº¡i.

---

## ğŸ› TROUBLESHOOTING

### Lá»—i: "Invalid authentication credentials"
- Check token cÃ³ Ä‘Ãºng khÃ´ng
- Check token chÆ°a háº¿t háº¡n (24 giá»)
- Check header: `Authorization: Bearer <token>`

### Lá»—i: "Admin access required"
- Check role trong token pháº£i lÃ  "admin"
- Re-login vá»›i admin account

### Lá»—i: "User not found"
- Check user_id cÃ³ tá»“n táº¡i trong database
- Check UUID format Ä‘Ãºng

### Lá»—i khi import
```bash
# ThÃªm PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:/path/to/be"
```

---

## ğŸ“ NOTES

1. **JWT Secret Key**: Äá»•i `JWT_SECRET_KEY` trong production (min 32 chars)
2. **Token Expiry**: Máº·c Ä‘á»‹nh 24 giá», cÃ³ thá»ƒ config trong `auth_middleware.py`
3. **Email OTP**: Cáº§n Gmail App Password Ä‘á»ƒ gá»­i email OTP
4. **Password**: Hiá»‡n táº¡i lÆ°u plain text, nÃªn hash báº±ng bcrypt trong production
5. **Pagination**: Default `limit=100`, cÃ³ thá»ƒ tÄƒng náº¿u cáº§n

---

## ğŸ‰ HOÃ€N THÃ€NH

Há»‡ thá»‘ng giá» cÃ³ Ä‘áº§y Ä‘á»§:
- âœ… JWT Authentication
- âœ… Role-based Authorization
- âœ… Admin Management
- âœ… Emotion Concepts CRUD
- âœ… Questions CRUD
- âœ… Game Contents CRUD
- âœ… Proper error handling
- âœ… Pagination & Filtering

**Next steps:**
1. Test táº¥t cáº£ endpoints
2. ThÃªm unit tests
3. Hash passwords (bcrypt)
4. Add rate limiting
5. Add logging
6. Deploy to production